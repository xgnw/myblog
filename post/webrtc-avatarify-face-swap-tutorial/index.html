<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.116.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple-touch-icon.png><meta itemprop=name content="实现前端网页 WebRTC 视频通话以及换脸特效"><meta itemprop=description content="请输入描述"><meta itemprop=image content="https://blog.jiandan.cf/imgs/babiwawa.png"><meta itemprop=keywords content="前端,WebRTC,avatarify"><meta property="og:type" content="article"><meta property="og:title" content="实现前端网页 WebRTC 视频通话以及换脸特效"><meta property="og:description" content="请输入描述"><meta property="og:image" content="/imgs/babiwawa.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blog.jiandan.cf/post/webrtc-avatarify-face-swap-tutorial/"><meta property="og:site_name" content="爸比娃娃的博客"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="峰华"><meta property="article:published_time" content="0001-01-01 00:00:00 +0000 UTC"><meta property="article:modified_time" content="0001-01-01 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.ad1ea33a63f63e6a94f5de191c205129577cfd392e2e10dec0f173ca5bdf0b7b.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"webrtc-avatarify-face-swap-tutorial","permalink":"https://blog.jiandan.cf/post/webrtc-avatarify-face-swap-tutorial/","title":"实现前端网页 WebRTC 视频通话以及换脸特效","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>实现前端网页 WebRTC 视频通话以及换脸特效 - 爸比娃娃的博客</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>爸比娃娃的博客</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>爸比娃娃的博客</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/flinks.html class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>友情链接</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>125</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#编写页面>编写页面</a><ul><li><a href=#html>HTML</a></li><li><a href=#css>CSS</a></li></ul></li><li><a href=#访问摄像头>访问摄像头</a></li><li><a href=#编写后台>编写后台</a></li><li><a href=#生成用户-id>生成用户 ID</a></li><li><a href=#呼叫视频通话>呼叫视频通话</a></li><li><a href=#应答视频通话>应答视频通话</a></li><li><a href=#实现换脸>实现换脸</a><ul><li><a href=#购买服务器>购买服务器</a></li><li><a href=#部署-avatarify>部署 Avatarify</a><ul><li><a href=#安装-docker>安装 Docker</a></li><li><a href=#安装-nvidia-docker-tookit>安装 Nvidia Docker tookit</a></li><li><a href=#构建-avatarify-docker-镜像>构建 Avatarify Docker 镜像</a></li></ul></li><li><a href=#安装-avatarify-客户端>安装 Avatarify 客户端</a></li><li><a href=#启动-avatarify-客户端>启动 Avatarify 客户端</a></li><li><a href=#windows-安装方法>Windows 安装方法</a></li><li><a href=#实现换脸-1>实现换脸</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=爸比娃娃 src=/imgs/img-lazy-loading.gif data-src=/imgs/babiwawa.png><p class=site-author-name itemprop=name>爸比娃娃</p><div class=site-description itemprop=description>有钱说什么都是硬道理，没钱说什么都是吹牛逼。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>125</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>4</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/babiwawa title="Github → https://github.com/babiwawa" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span>
<span class=links-of-social-item><a href=mailto:1223112302@qq.com title="E-Mail → mailto:1223112302@qq.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/hbalnw title="知乎 → https://www.zhihu.com/people/hbalnw" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://jiandan.cf title=https://jiandan.cf target=_blank>简单导航</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=0001-01-01T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=287557></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=640></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-01-04T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title=直达底部><i class="fas fa-arrow-down"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/babiwawa rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blog.jiandan.cf/post/webrtc-avatarify-face-swap-tutorial/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/babiwawa.png"><meta itemprop=name content="峰华"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="爸比娃娃"><meta itemprop=description content="有钱说什么都是硬道理，没钱说什么都是吹牛逼。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="实现前端网页 WebRTC 视频通话以及换脸特效"><meta itemprop=description content="请输入描述"></span><header class=post-header><h1 class=post-title itemprop="name headline">实现前端网页 WebRTC 视频通话以及换脸特效</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：0001-01-01 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="0001-01-01 00:00:00 +0000 UTC">0001-01-01</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>7384</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>15分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv data-path=/post/webrtc-avatarify-face-swap-tutorial/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p>因为疫情的原因，线上视频会议软件异军突起，成为了在家办公的主要沟通渠道。而最近抖音上“蚂蚁呀嘿”恶搞换脸的小视频也突然火了起来，那我就想了想能不能在视频会议的时候换张脸活跃下气氛？在 Github 上一番搜寻之后发现还真有办法，有一个开源的 Python 人工智能换脸的库，那正好趁着这个机会研究一下前端 WebRTC 实现视频通话功能，外加换脸操作。先看一下效果吧：</p><p>&lt;Video src={require("./img/2021-03-14-webrtc-avatarify-face-swap-tutorial/webrtc-avatarify-face-swap-demo.mp4").default} /></p><p>因为有涉及到一点点的后台，所以项目分成了两部分，一个是用于存放前端代码的 frontend 项目和存放后端代码的 backend 项目：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>项目根目录
</span></span><span style=display:flex><span>  |-- backend
</span></span><span style=display:flex><span>  |-- frontend
</span></span></code></pre></div><p>另外这个视频需要电脑上有摄像头，没有的话可以想办法把手机当作电脑的摄像头。</p><p><strong>注意：本教程中的代码仅供展示 AI 换脸技术的应用，不可以用于获取其他人隐私或其他任何非法目的。</strong></p><h2 id=编写页面>编写页面
<a class=header-anchor href=#%e7%bc%96%e5%86%99%e9%a1%b5%e9%9d%a2></a></h2><p>因为是前端实现，首先肯定是编写页面。这个页面比较简单，就是一个视频组件、显示用户 ID 的文本、呼叫对方视频的输入框和按钮，视频组件默认显示自己的视频，当视频接通之后就会显示对方的视频，而自己的视频会缩小到右上角。</p><h3 id=html>HTML
<a class=header-anchor href=#html></a></h3><p>在 frontend 目录下新建 index.html、style.css 和 index.js 文件。首先看一下 HTML 结构，index.html 中主要的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!-- frontend/index.html --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- 其他代码 --&gt;</span>
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;stylesheet&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;style.css&#34;</span> /&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>main</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;container&#34;</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;videos&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>video</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;myVideo&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;videoSize&#34;</span> <span style=color:#a6e22e>autoplay</span>&gt;&lt;/<span style=color:#f92672>video</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>video</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;peerVideo&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;videoSize&#34;</span> <span style=color:#a6e22e>autoplay</span>&gt;&lt;/<span style=color:#f92672>video</span>&gt;
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;idText&#34;</span>&gt;&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;call&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;peerIdInput&#34;</span> <span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;请输入对方 id&#34;</span> /&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;joinBtn&#34;</span>&gt;视频通话&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#f92672>main</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;index.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span></code></pre></div><p>每个标签的作用是：</p><ul><li><code>&lt;main /></code>  用于设置页面背景，把所有组件居中对齐。</li><li><code>&lt;div class="videos"></code>  里边分别放了显示自己视频 <code>#myVideo</code>  和对方视频 <code>#peerVideo</code>  的 <code>&lt;video /></code>  组件，并设置为自动播放，以便于在加载摄像头后立刻开始播放画面。</li><li><code>&lt;p id="idText"></code> 在页面打开时显示自己的用户 ID，相当于是电话号码。</li><li><code>&lt;div class="call"></code>  里是输入对方 ID 的文本框 <code>#peerIdInput</code>  和呼叫按钮 <code>#joinBtn</code> 。</li><li>最后在 <code>&lt;head /></code>  中引入样式文件 style.css，在 <code>&lt;body /></code>  结束前引入 index.js。我们将主要在 index.js 中编写代码。</li></ul><h3 id=css>CSS
<a class=header-anchor href=#css></a></h3><p>css 的代码都比较简单，基本就是设置一下样式，这里介绍一下重要的部分，剩余的可以在源代码中查看。因为自己的视频要在视频接通时移动到右上角，那么就需要把 <code>&lt;div class="videos"></code> 容器设置为相对定位，把我的视频和对方的视频设置成一样的宽高，然后先隐藏对方视频，当视频接通时，利用 JavaScript 加上接通后，我的视频的样式，把我的视频设置为绝对定位，宽高调小，放到右上角：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#75715e>/* frontend/style.css */</span>
</span></span><span style=display:flex><span><span style=color:#f92672>videos</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>position</span>: <span style=color:#66d9ef>relative</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.<span style=color:#a6e22e>videoSize</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>width</span>: <span style=color:#ae81ff>500</span><span style=color:#66d9ef>px</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>height</span>: <span style=color:#ae81ff>600</span><span style=color:#66d9ef>px</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>object-fit</span>: <span style=color:#66d9ef>cover</span>; <span style=color:#75715e>/* 让视频按比例占满整个空间 */</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.<span style=color:#a6e22e>rightTop</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* 以下是通话中的样式 */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>position</span>: <span style=color:#66d9ef>absolute</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>width</span>: <span style=color:#ae81ff>150</span><span style=color:#66d9ef>px</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>height</span>: <span style=color:#ae81ff>180</span><span style=color:#66d9ef>px</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>right</span>: <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>top</span>: <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#peerVideo {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>display</span>: <span style=color:#66d9ef>none</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其他组件基本只是设置了下 Grid 布局、宽高、大小、阴影、背景、字体，没有什么特殊的，可以直接查看源代码。样式中所用到的图标在 <code>frontend/icons</code>  目录下。</p><h2 id=访问摄像头>访问摄像头
<a class=header-anchor href=#%e8%ae%bf%e9%97%ae%e6%91%84%e5%83%8f%e5%a4%b4></a></h2><p>接下来我们先熟悉一下访问摄像头的代码。在 JavaScript 中访问用户的摄像头主要使用 <code>navigator.mediaDevices.getUserMedia()</code> 方法，  它接收一个对象作为参数，用于指定要获取的设备，例如视频或音频，然后返回一个 Promise，在 Promise 完成之后它会传递给我们一个 Stream 流，我们把它放到 <code>&lt;video /></code>  标签的 <code>srcObject</code>  属性中就可以了，是不是很简单？代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// frontend/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>myVideo</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;myVideo&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>mediaDevices</span>
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>getUserMedia</span>({ <span style=color:#a6e22e>video</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>audio</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>stream</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myVideo</span>.<span style=color:#a6e22e>srcObject</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stream</span>;
</span></span><span style=display:flex><span>  });
</span></span></code></pre></div><p>在这段代码中：</p><ul><li>获取了 <code>#myVideo</code>  这个 <code>&lt;video /></code>  组件。</li><li>使用 <code>navigator.mediaDevices.getUserMedia()</code> 并给它传递了一个对象，对象的 video 和 audio 属性都设置为了 true，表示要访问摄像头和音频设备。</li></ul><p>这时，使用 VS Code 的 Live Server 插件运行项目（没有的话安装一下，很简单），在 index.html 文件里右击，选择 Open with Live Server，打开之后，浏览器可能会提示此网站需要访问摄像头和音频设备，点击允许，就能看到自己的视频了。</p><h2 id=编写后台>编写后台
<a class=header-anchor href=#%e7%bc%96%e5%86%99%e5%90%8e%e5%8f%b0></a></h2><p>要实现视频通话，需要使用 WebRTC 技术，这个技术牵扯的概念和 API 过于庞大和复杂，不过有开源的库来帮我们简化了 WebRTC 的操作，这里使用一个叫做 Peer.js 的库，它封装了 WebRTC 杂乱的 API，提供了完整的、可配置的、易于使用的 API。
<a href=https://peerjs.com/ title=https://peerjs.com/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://peerjs.com/
<i class="fa fa-external-link-alt"></i></a>
我们将会通过把 Peer 附加到 Express.js 服务器上，来生成用户 ID 并管理 WebRTC 连接。首先在 backend 目录下运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>npm init -y
</span></span><span style=display:flex><span><span style=color:#75715e># 或</span>
</span></span><span style=display:flex><span>yarn init -y
</span></span></code></pre></div><p>接着初始化一个 node.js 项目，使用 npm 或 yarn 安装 peer 和 express 依赖，因为想在改动代码时自动重启服务，我们也可以再安装一个 nodemon 依赖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>yarn add peer express nodemon
</span></span><span style=display:flex><span><span style=color:#75715e># 或</span>
</span></span><span style=display:flex><span>npm install --save peer express nodemon
</span></span></code></pre></div><p>安装完成之后新建一个 server.js 文件，整个后台服务我们就只需要这一个文件，都是一些简单的初始化代码，它里边的内容是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ExpressPeerServer</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;peer&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>peerServer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ExpressPeerServer</span>(<span style=color:#a6e22e>server</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>debug</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/&#34;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/video&#34;</span>, <span style=color:#a6e22e>peerServer</span>);
</span></span></code></pre></div><p>这些代码的含义是：</p><ul><li>导入 express 库，并从 peer 库中导入与 express 进行结合的 ExpressPeerServer。</li><li>创建 express 实例 <code>app</code> ，并监听 <code>3000</code>  端口。</li><li>把 ExpressPeerServer 挂载到 express 中，设置 <code>debug</code>  开发模式为 true，这样有更好的错误提示。路径为根目录。</li><li>ExpressPeerServer 挂载之后会返回一个 express 的控制器。</li><li>把返回的控制器挂载到 <code>/video</code>  路径下，这样 <code>/video</code>  路径就是主要的、peer.js 提供的 WebRTC 通信路径。</li></ul><p>然后修改一下 package.json 文件，添加一个 <code>script</code>  配置项，里边定义 <code>start</code>  命令值为 <code>nodemon server.js</code> ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>  <span style=color:#e6db74>&#34;scripts&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;nodemon server.js&#34;</span>
</span></span><span style=display:flex><span>  }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span></code></pre></div><p>这样使用 nodemon 运行 server.js 文件后，如果 server.js 中的内容发生变化，它会自动帮助我们重启服务器。
我们现在来运行一下 <code>yarn start</code>  或者 <code>npm start</code> ，看到命令行提示 <code>[nodemon] starting node server.js</code>  就算启动成功了，我们访问一下 <code>http://localhost:3000/video</code>  ，看到下方输出结果就说明 peer 也加载成功了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;PeerJS Server&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;A server side element to broker connections between PeerJS clients.&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;website&#34;</span>: <span style=color:#e6db74>&#34;https://peerjs.com/&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>后端代码到这里就编写完成了。下一步就是在前端页面中调用 Peer 相关的 api，并建立视频通话。</p><h2 id=生成用户-id>生成用户 ID
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e7%94%a8%e6%88%b7-id></a></h2><p>在前端中调用后端 Peer 服务可以使用 Peer.js 官方的前端库，可以直接使用 cdn 形式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>也可以打开上边 src 中的网址，把文件保存到本地，或者在 Github 上下载：
<a href=https://github.com/peers/peerjs/blob/master/dist/peerjs.min.js title=https://github.com/peers/peerjs/blob/master/dist/peerjs.min.js rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/peers/peerjs/blob/master/dist/peerjs.min.js
<i class="fa fa-external-link-alt"></i></a>
下载完成之后把它放到 <code>frontend/peer</code>  目录下，然后在 index.html 中，在引入 index.js 的上方，引入 peerjs：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;peer/peerjs.min.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;index.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>接下来打开 index.js 文件，建立与后台 peer 服务的连接：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>peer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Peer</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;3000&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/video&#34;</span>,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>这里直接使用 peer.js 前端库导出的构造函数 Peer()，它接收一个对象作为参数，这里就分别把后台服务的 host、port 和 path 传递进去就可以了，它会返回 peer 实例，后续有关视频通话的操作就主要使用它来实现。
当成功的连接到后台服务之后，我们首先给自己生成一个唯一的用户 ID，就等同于是一个电话号码，那么这里我们可以监听 peer 的 <strong>open</strong>  事件，当连接打开后，会把生成的用户 ID 返回到事件处理回调函数中，然后我们获取 html 中的 <code>#idText</code>  这个 p 元素来显示自己的 ID：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>idText</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;idText&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>peer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;open&#34;</span>, (<span style=color:#a6e22e>id</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>idText</span>.<span style=color:#a6e22e>textContent</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;我的 id 是：&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>这时在 Live Server 中打开 index.html，就可以看到显示出了 ID，类似于：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>我的 id 是：2573c3ae-ba79-404a-b807-2128856ef3c9
</span></span></code></pre></div><p>多打开几个页面，可以看到每个人的 ID 都不同。</p><h2 id=呼叫视频通话>呼叫视频通话
<a class=header-anchor href=#%e5%91%bc%e5%8f%ab%e8%a7%86%e9%a2%91%e9%80%9a%e8%af%9d></a></h2><p>在有了用户 ID 之后，就可以呼叫对方了。这里的逻辑是，用户在输入框输入对方 ID 之后，点击视频通话按钮进行呼叫。那么我们应该先获取视频通话按钮元素，然后监听它的点击事件，在里边发起呼叫：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>joinBtn</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;joinBtn&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// 发起呼叫
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>joinBtn</span>.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;click&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>peerId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>peerIdInput</span>.<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;正在连接：&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>peerId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>mediaDevices</span>
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>getUserMedia</span>({ <span style=color:#a6e22e>video</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>audio</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>stream</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>call</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>peer</span>.<span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>peerId</span>, <span style=color:#a6e22e>stream</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>call</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;stream&#34;</span>, <span style=color:#a6e22e>showVideo</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>在点击按钮的时候，事件处理函数作了如下操作：</p><ul><li>获取用户输入的对方的 ID。</li><li>获取当前用户的视频流，然后调用 <code>peer.call()</code>  呼叫对方， <code>peer.call()</code>  需要对方的 ID 和自己的视频流作为参数，然后返回与呼叫有关的实例，保存到 call 中。</li><li>这时当前用户就开始等待对方应答了，为了简单起见，这里没有做等待的样式。</li><li>下一步监听 call 的 <strong>stream</strong>  事件，这个事件会在对方应答后触发，它会返回对方的视频流作为事件处理函数的参数，然后我们使用 <code>showVideo()</code>  函数处理对方的视频流。</li></ul><p><code>showVideo()</code>  函数的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>peerVideo</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;peerVideo&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>showVideo</span>(<span style=color:#a6e22e>stream</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>myVideo</span>.<span style=color:#a6e22e>classList</span>.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;rightTop&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>peerVideo</span>.<span style=color:#a6e22e>srcObject</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stream</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>peerVideo</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>display</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;block&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个函数就是简单的把自己的视频移动到右上角，通过之前定义的 <code>.rightTop</code> class 样式，然后把对方的视频流放到 <code>#peerVideo</code>  视频组件中，之后把它显示出来（之前设置的是 <code>display: none</code>  隐藏）。现在因为一直是等待对方接听，所以需要有一个应答的处理。</p><h2 id=应答视频通话>应答视频通话
<a class=header-anchor href=#%e5%ba%94%e7%ad%94%e8%a7%86%e9%a2%91%e9%80%9a%e8%af%9d></a></h2><p>应答的处理是监听 peer 的 <strong>call</strong>  事件，然后通过事件参数中与呼叫有关的实例来应答通话：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 应答呼叫
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>peer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;call&#34;</span>, (<span style=color:#a6e22e>call</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>mediaDevices</span>
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>getUserMedia</span>({ <span style=color:#a6e22e>video</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>audio</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>stream</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>call</span>.<span style=color:#a6e22e>answer</span>(<span style=color:#a6e22e>stream</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>call</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;stream&#34;</span>, <span style=color:#a6e22e>showVideo</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>这一步的代码虽然在同一个文件中，但是应该想象为收到视频通话呼叫的对方，代码作了下边的操作：</p><ul><li>获取自己的视频流。</li><li>调用 <code>answer()</code>  函数应答视频呼叫，并把自己的视频流传回给呼叫者。这里是当有呼叫时直接进行应答，为了简单起见，没有编写点击应答按钮相关的样式和事件。</li><li>监听 ** stream **  事件，这一步和之前的一样，应答后这个事件就会触发，然后同样使用 <code>showVideo()</code> 函数加载视频。</li></ul><p>好了，现在打开两个页面试试，在其中一个页面输入另一个页面生成的 ID，然后点击视频通话，就可以看到双方视频显示出来了。如果用的是同一个摄像头，那么显示的画面都是一样的。</p><h2 id=实现换脸>实现换脸
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e6%8d%a2%e8%84%b8></a></h2><p>实现换脸主要是用到了 Avatarify 这个 AI 换脸库，它是使用 Python 编写的，利用了 First-Order Motion Model 算法来实现换脸。我们这里只需要按照步骤进行安装就可以了，此外还需要安装虚拟摄像头软件，用于把 Avatarify 换脸后的数据作为摄像头视频，然后在前端页面中访问这个虚拟的摄像头。
Avatarify 由于是对摄像头的视频进行实时计算，所以对显卡的要求非常高，且只支持启用了 CUDA 的 Nvidia 显卡来进行 GPU 加速，官方的统计数据是这样的：</p><ul><li>GeForce GTX 1080 Ti: 33 帧/秒</li><li>GeForce GTX 1070: 15 帧/秒</li><li>GeForce GTX 950: 9 帧/秒</li></ul><p>如果配置达不到，可以使用腾讯云或阿里云的 GPU 实例，把显卡有关的计算交给远程服务器去进行，本地只需要建立视频流即可。本文将主要使用这种方法。
如果配置达到了要求，也可以在本地安装运行，不过我没有试过，后边简单的贴一下官方安装指导（Windows 下），你可以自己尝试一下。
要注意的是，如果是在本地运行算法，可以在 Windows 和 Linux 操作系统中进行，或者也可以使用 docker 进行部署，不过只支持 linux 操作系统下的 docker。</p><h3 id=购买服务器>购买服务器
<a class=header-anchor href=#%e8%b4%ad%e4%b9%b0%e6%9c%8d%e5%8a%a1%e5%99%a8></a></h3><p>这里以腾讯云 GPU 实例为例，介绍一下服务器的配置，关于计费我们会使用按量计费，完成这篇教程所用的总体费用可能在 30 元左右，
用完之后一定要记得<strong>关机或者销毁来停止计费</strong>。如果是关机，记得先把带宽调整为 0，停止带宽计费，然后关机时选择关机不收费选项。
打开下方链接（或复制
<a href=https://curl.qcloud.com/KiCrCXo9 title=https://curl.qcloud.com/KiCrCXo9 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://curl.qcloud.com/KiCrCXo9
<i class="fa fa-external-link-alt"></i></a> ）：</p><p><a href="https://cloud.tencent.com/act/cps/redirect?redirect=1001&amp;cps_key=2c427bf21a8dbca51ee45224ab31c2a9&amp;from=console" title=腾讯云服务器购买链接 rel="noopener external nofollow noreferrer" target=_blank class=exturl>腾讯云服务器购买链接
<i class="fa fa-external-link-alt"></i></a></p><p>然后在选择机型中选择如下配置：</p><ul><li>计费模式：按量计费。</li><li>地域：中国香港。这里选择香港地区的原因是安装 Avatarify 需要大量的境外源，例如 Github、Docker、Nividia、Python 等，且数量多，体积也大（有的 700 多 M），在亲身测试过国内区的之后，发现行不通，而香港地区因为延迟相对较低，且访问境外源速度快，所以这里选择了香港。</li><li>实例：选择 GPU 型，在机型列表中选择 GPU 计算型 GN7，这个是最便宜的，7.16 元/小时。</li><li>镜像：选择 Ubuntu 64 位 18.04，不要选过高的版本。显卡驱动可能支持不完善。</li><li>勾选上后台自动安装 GPU 驱动，CUDA 版本选择 10.0.130，cuDNN 版本选择 7.4.2。</li><li>带宽实测需要 20M 起步，大概 1 元/小时，不过在安装 Avatarify 的时候带宽可以小一点，后边真正开启视频的时候再把它改大。</li><li><strong>注意这里系统盘费用是 0.03 元/小时，这个在关机后仍然会收取</strong>。</li></ul><p>在下一步设置主机中：</p><ul><li>新建安全组。</li><li>登录方式这里使用密码，可以选择自行设置，也可以自动生成。</li></ul><p>再下一步确认成功后完成购买，稍后就可以在控制台实例列表中看到刚购买的实例了，新购买的机器可能需要等 5 分钟才能配置完成。如果要修改带宽，可以在列表中找到对应的实例，在最右侧操作栏里选择更多->资源调整->调整带宽，进行调整。
因为 Avatarify 需要使用 5557 和 5558 端口，我们需要在安全组中放行这两个端口。点击实例名称超链接，进入实例详情页面，在上方选项卡中选择 <strong>安全组</strong> ，在右侧 <strong>规则预览</strong>  中的 <strong>入站规则</strong>  选项卡里，点击 <strong>编辑规则</strong>，在新页面里的入站规则里，点击 **添加规则，**在对话框里填写：</p><ul><li>类型：自定义。</li><li>来源：all。</li><li>协议端口：TCP:5557,5558</li><li>策略：允许。</li></ul><p>点击完成即可。到这里实例配置就完成了，留意一下实例的公网 IP 地址，稍后使用 SSH 登录时需要用到它。</p><h3 id=部署-avatarify>部署 Avatarify
<a class=header-anchor href=#%e9%83%a8%e7%bd%b2-avatarify></a></h3><p>我们使用 Docker 的方式来部署 Avatarify，先登录到我们的 GPU 实例中，可以直接在腾讯云控制台登录，也可以使用 ssh 命令或 putty 工具。这里以 ssh 为例，输入如下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>ssh ubuntu@你的实例ip
</span></span></code></pre></div><p>然后根据提示输入密码，第一次登录可能有一大段英文提示（是否信任设备），直接输入 yes 回车即可。</p><h4 id=安装-docker>安装 Docker
<a class=header-anchor href=#%e5%ae%89%e8%a3%85-docker></a></h4><p>登录进去之后先安装 docker，可以直接使用简易的安装脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://get.docker.com -o get-docker.sh
</span></span><span style=display:flex><span>sudo sh get-docker.sh
</span></span></code></pre></div><p>不过实测香港的实例好像并不能访问这个脚本，我们还可以使用普通方式安装，按照以下步骤复制粘贴命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 第一步</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第二步</span>
</span></span><span style=display:flex><span>sudo apt-get install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-transport-https <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ca-certificates <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gnupg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第三步</span>
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第四步</span>
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span></code></pre></div><p>这些步骤都是在配置 Docker 的安装仓库源和密钥，接下来运行下面两条命令来安装 Docker：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install docker-ce docker-ce-cli containerd.io
</span></span></code></pre></div><p>安装完成之后， <code>docker</code>  命令需要管理员权限才能运行，每次都需要输入 <code>sudo</code>，如果要省略 <code>sudo</code> ，可以把当前用户（腾讯云默认为 ubuntu）添加到 docker 用户组中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo usermod -aG docker ubuntu
</span></span></code></pre></div><p>之后退出 ssh 并重新登录来让配置生效，我们可以运行下面的命令检查 docker 是否安装成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>docker run hello-world
</span></span></code></pre></div><p>有打印出 hello world 字样和一大段英文就说明成功了。</p><h4 id=安装-nvidia-docker-tookit>安装 Nvidia Docker tookit
<a class=header-anchor href=#%e5%ae%89%e8%a3%85-nvidia-docker-tookit></a></h4><p>要让 docker 使用 GPU，需要安装 Nvidia Docker tookit，这一步也很简单，首先设置 Nvidia 的仓库源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>distribution<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>. /etc/os-release;echo $ID$VERSION_ID<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
</span></span></code></pre></div><p>然后安装 tookit 并重启 Docker：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y nvidia-docker2
</span></span><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div><p>运行一个示例 container 检查是否安装成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker run --rm --gpus all nvidia/cuda:11.0-base nvidia-smi
</span></span></code></pre></div><p>如果打印出类似的如下信息就算成功了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>Fri Mar  <span style=color:#ae81ff>5</span> 08:47:39 <span style=color:#ae81ff>2021</span>
</span></span><span style=display:flex><span>+-----------------------------------------------------------------------------+
</span></span><span style=display:flex><span>| NVIDIA-SMI 418.126.02   Driver Version: 418.126.02   CUDA Version: 11.0     |
</span></span><span style=display:flex><span>|-------------------------------+----------------------+----------------------+
</span></span><span style=display:flex><span>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span></span><span style=display:flex><span>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
</span></span><span style=display:flex><span>|<span style=color:#f92672>===============================</span>+<span style=color:#f92672>======================</span>+<span style=color:#f92672>======================</span>|
</span></span><span style=display:flex><span>|   <span style=color:#ae81ff>0</span>  Tesla T4            Off  | 00000000:00:08.0 Off |                    <span style=color:#ae81ff>0</span> |
</span></span><span style=display:flex><span>| N/A   26C    P8     9W /  70W |      0MiB / 15079MiB |      0%      Default |
</span></span><span style=display:flex><span>+-------------------------------+----------------------+----------------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+-----------------------------------------------------------------------------+
</span></span><span style=display:flex><span>| Processes:                                                       GPU Memory |
</span></span><span style=display:flex><span>|  GPU       PID   Type   Process name                             Usage      |
</span></span><span style=display:flex><span>|<span style=color:#f92672>=============================================================================</span>|
</span></span><span style=display:flex><span>|  No running processes found                                                 |
</span></span><span style=display:flex><span>+-----------------------------------------------------------------------------+
</span></span></code></pre></div><h4 id=构建-avatarify-docker-镜像>构建 Avatarify Docker 镜像
<a class=header-anchor href=#%e6%9e%84%e5%bb%ba-avatarify-docker-%e9%95%9c%e5%83%8f></a></h4><p>选择一个文件夹，使用 git 克隆 Avatarify 仓库：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/alievk/avatarify.git
</span></span></code></pre></div><p>进入到克隆下来的 avatarify 仓库中，使用 docker 构建镜像：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd avatarify
</span></span><span style=display:flex><span>docker build -t avatarify .
</span></span></code></pre></div><p>构建需要的时间比较长，耐心等待完成之后，启动服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>bash run.sh --is-worker --docker
</span></span></code></pre></div><p>看到有 5557 和 5558 端口就说明启动成功了。到现在，Avatarify 的服务端配置完成了，之后就是使用客户端调用服务，把计算部分交给我们的 GPU 实例。这时如果担心计费，可以先把实例关机，在本地安装好客户端后再开机。
接下来的步骤以 MacOS 为例，Windows 版可以直接跳到后边的 <strong>Windows 安装方法</strong>  小节。</p><h3 id=安装-avatarify-客户端>安装 Avatarify 客户端
<a class=header-anchor href=#%e5%ae%89%e8%a3%85-avatarify-%e5%ae%a2%e6%88%b7%e7%ab%af></a></h3><p>在本地电脑上，首先安装 Miniconda Python 3.8，可以从这里下载：
<a href=https://docs.conda.io/en/latest/miniconda.html#macosx-installers title=https://docs.conda.io/en/latest/miniconda.html#macosx-installers rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://docs.conda.io/en/latest/miniconda.html#macosx-installers
<i class="fa fa-external-link-alt"></i></a>
或者使用 Homebrew：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>brew install --cask miniconda
</span></span></code></pre></div><p>克隆 avatarify 仓库并运行安装脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/alievk/avatarify.git
</span></span><span style=display:flex><span>cd avatarify
</span></span><span style=display:flex><span>bash scripts/install_mac.sh
</span></span></code></pre></div><p>下载 CamTwist 虚拟摄像头软件（类似 OBS，但是 OBS 的虚拟摄像头在 Mac 中访问不到）并安装：
<a href=http://camtwiststudio.com/download title=http://camtwiststudio.com/download rel="noopener external nofollow noreferrer" target=_blank class=exturl>http://camtwiststudio.com/download
<i class="fa fa-external-link-alt"></i></a></p><h3 id=启动-avatarify-客户端>启动 Avatarify 客户端
<a class=header-anchor href=#%e5%90%af%e5%8a%a8-avatarify-%e5%ae%a2%e6%88%b7%e7%ab%af></a></h3><p>确保远程 GPU 实例已启动，且运行了 avatarify docker 镜像监听 5557 和 5558 端口，然后在本地克隆的 avatarify 仓库中，运行 mac 客户端：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>./run_mac.sh --is-client --in-addr tcp://server_address:5557 --out-addr tcp://server_address:5558
</span></span></code></pre></div><p>记得把两个 <code>server_address</code>  改成 GPU 实例的公网 IP。服务端可能需要下载一些必要的文件，所以连接会慢一些，稍等启动成功后 Avatarify 会自动打开摄像头窗口。
我们可以根据提示调整好脸部位置，这里我们最好把脸放到红色矩形框中，光线要充足，不能太黑，可以使用 W/D 键缩放画面，调整好之后按 X 键就可以呼出换脸之后的预览视频窗口，它就是作为虚拟摄像头的视频来源。
Avatarify 内置了 9 张示例的人脸照片，可以按 1-9 键进行切换，也可以自定义人脸照片，放到 Avatarify 中的 <code>avatars</code>  文件夹下。
Avatarify 成功显示之后，打开 CamTwist 虚拟摄像头，在左侧选择 Desktop+，然后点击底部的 select，然后在右侧的 settings 下，勾上 Confine to Application Window，然后勾上下方的 Select from existing windows ，在下拉框中选择 python (avatarify) ，如果找不到可以退出 CamTwist 重新打开，或者多点击下拉框几次试试。现在虚拟摄像头就准备好了。</p><h3 id=windows-安装方法>Windows 安装方法
<a class=header-anchor href=#windows-%e5%ae%89%e8%a3%85%e6%96%b9%e6%b3%95></a></h3><p>在 Windows 下的安装方法与 MacOS 类似，而且如果显卡配置够高，可以省略购买远程 GPU 服务器步骤。</p><ol><li>首先安装 Minicoda Python 3.8，可以从这里下载：</li></ol><p><a href=https://docs.conda.io/en/latest/miniconda.html#windows-installers title=https://docs.conda.io/en/latest/miniconda.html#windows-installers rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://docs.conda.io/en/latest/miniconda.html#windows-installers
<i class="fa fa-external-link-alt"></i></a></p><ol start=2><li>安装完成之后打开 Anaconda 命令提示符，克隆 avatarify 仓库，并运行 windows 操作系统下的安装脚本：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/alievk/avatarify.git
</span></span><span style=display:flex><span>cd avatarify
</span></span><span style=display:flex><span>scripts<span style=color:#ae81ff>\i</span>nstall_windows.bat
</span></span></code></pre></div><ol start=3><li>如果要在本地执行换脸算法，那么需要下载 network weights（228 MB）：</li></ol><p><a href=https://openavatarify.s3.amazonaws.com/weights/vox-adv-cpk.pth.tar title=https://openavatarify.s3.amazonaws.com/weights/vox-adv-cpk.pth.tar rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://openavatarify.s3.amazonaws.com/weights/vox-adv-cpk.pth.tar
<i class="fa fa-external-link-alt"></i></a>
或
<a href=https://yadi.sk/d/M0FWpz2ExBfgAA title=https://yadi.sk/d/M0FWpz2ExBfgAA rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://yadi.sk/d/M0FWpz2ExBfgAA
<i class="fa fa-external-link-alt"></i></a>
或
<a href="https://drive.google.com/file/d/1coUCdyRXDbpWnEkA99NLNY60mb9dQ_n3/view?usp=sharing" title="https://drive.google.com/file/d/1coUCdyRXDbpWnEkA99NLNY60mb9dQ_n3/view?usp=sharing" rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://drive.google.com/file/d/1coUCdyRXDbpWnEkA99NLNY60mb9dQ_n3/view?usp=sharing
<i class="fa fa-external-link-alt"></i></a></p><ol start=4><li>下载完成后放到 avatarify 的根目录下，无需解压。</li><li>运行 avatarify 客户端，如果是在本地运行，可以使用：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>./scripts/run_windows.bat
</span></span></code></pre></div><ol start=6><li>Windows 系统下也可以使用远程 GPU 实例，使用下面的方式启动客户端：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>./scripts/run_windows.bat --is-client --in-addr tcp://server_address:5557 --out-addr tcp://server_address:5558
</span></span></code></pre></div><ol start=7><li>两个 <code>server_address</code>  需要替换成远程 GPU 实例的公网 IP。</li><li>启动成功之后和 Mac 的操作一样，使用 W/D 缩放画面，完成之后按 X 键调出 avatarify 预览窗口。</li></ol><p>Windows 下的虚拟摄像头可以使用 OBS，最新版的 OBS 26.1 及以上已经内置了虚拟摄像头插件了，无需再单独安装。</p><ol><li>下载并安装 OBS：</li></ol><p><a href=https://obsproject.com/ title=https://obsproject.com/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://obsproject.com/
<i class="fa fa-external-link-alt"></i></a></p><ol start=2><li>安装完成之后打开 OBS，在左下角的 Source（源）面板中添加 Windows Capture，把视频输入源设置为某个应用程序窗口，然后选择 [python.exe]: avatarify 程序，点击 OK，可以调整以下大小。</li><li>再在 Tools（工具）菜单中选择 VirtualCam（虚拟摄像头），选择 AutoStart（自动开启），设置 Buffered Frames（缓冲）为 0，然点击开始。（如果 Tools 菜单没有 VirtualCam，看看界面右下角的 start recording 附近有没有 start virtual cam）。</li></ol><p>现在虚拟摄像头就准备好了。</p><h3 id=实现换脸-1>实现换脸
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e6%8d%a2%e8%84%b8-1></a></h3><p>接下来就是在我们的视频通话前端项目中，使用 CamTwist 或 OBS 提供的虚拟摄像头了。我们需要明确知道它们的设备 ID 才能指定具体使用哪个摄像头。
首先使用 Live Server 打开前端项目的 index.html 文件，在谷歌开发者工具的 console 中，使用下面这段代码打印出视频设备信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>mediaDevices</span>.<span style=color:#a6e22e>enumerateDevices</span>().<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>devices</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>devices</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>device</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>device</span>.<span style=color:#a6e22e>kind</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;videoinput&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>device</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>这段代码就是访问所有媒体设备，然后获取其中的视频设备并打印出来，从打印结果里找到 label 包含 CamTwist 或者 OBS（视操作系统而定）的那一项，记录 deviceId 属性。
在 index.js 文件中，保存 deviceId 值到一个常量中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cameraId</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;982947417cf490bae44ffb6a837bddcb813704ee491dd85d9149c45389f5521b&#34;</span>;
</span></span></code></pre></div><p>在使用 <code>navigator.mediaDevices.getUserMedia()</code>  获取摄像头时，除了可以把 video 设置为 true 之外，还可以把他的值设置为一个对象，用来指定更多的信息，我们把它单独定义出来，在里边使用 cameraId 指定访问哪个摄像头：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaConstrains</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>video</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>deviceId</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exact</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>cameraId</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>audio</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>exact 是精确的、只使用指定 ID 的摄像头，不会使用其他备选的。
然后在获取自己摄像头设备的部分，替换成上边这个对象。或者为了方便测试，也可以把所有的都替换掉：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>mediaDevices</span>.<span style=color:#a6e22e>getUserMedia</span>(<span style=color:#a6e22e>mediaConstrains</span>).<span style=color:#a6e22e>then</span>(<span style=color:#75715e>/* ... */</span>);
</span></span></code></pre></div><p>好了，现在再试试视频通话，是不是成功的换脸了呢？
这里要注意的是，可能是因为 CamTwist 软件和真正的摄像头有冲突，页面会不时的重新刷新，这个暂时还没有比较好的解决方案，如果你有精力的话可以研究一下。
附上本文的源代码：
<a href=https://github.com/zxuqian/code-examples/tree/master/webrtc/video-call-change-face title=https://github.com/zxuqian/code-examples/tree/master/webrtc/video-call-change-face rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/zxuqian/code-examples/tree/master/webrtc/video-call-change-face
<i class="fa fa-external-link-alt"></i></a></p><h2 id=总结>总结
<a class=header-anchor href=#%e6%80%bb%e7%bb%93></a></h2><p>这篇教程所用到的技术都很简单，只是配置比较复杂，本教程提供了换脸的基本步骤，剩下的可以根据需要继续进行完善。示例中实现的的是一对一的视频通话，不过在这个基础上也完全可以实现多方视频会议，只需要调整一下视频显示的样式，然后在有新人加进来时，创建相应的 <code>&lt;video /></code>  标签，并追加到现有的视频列表中即可。现在我们来回顾一下过程：</p><ul><li>编写前端 HTML/CSS 页面结构和样式，并尝试加载摄像头。</li><li>编写简单的后台应用，利用 epxress 和 peer 建立基于 WebRTC 的视频通话基础。</li><li>前端利用 peer.js 前端库调用后台生成用户 ID，并呼叫、应答视频通话。</li><li>配置 Avatarify 换脸服务器程序，利用云 GPU 服务把显卡计算相关部分转移到 GPU 实例中。</li><li>安装 Avatarify 客户端程序和虚拟摄像头应用，把换脸后的数据用虚拟摄像头展现出来。</li><li>前端获取虚拟摄像头 ID，在视频通话的时候使用此摄像头。</li></ul><p>如果有帮助请点赞并分享，有问题可以评论留言，感谢阅读！</p><p>import Video from &ldquo;@site/src/components/Video&rdquo;;</p></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%89%8d%e7%ab%af>前端</a>
<a href=/tags/webrtc>WebRTC</a>
<a href=/tags/avatarify>avatarify</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="爸比娃娃 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="爸比娃娃 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
实现前端网页 WebRTC 视频通话以及换脸特效</li><li class=post-copyright-author><strong>原文作者：</strong>
峰华</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blog.jiandan.cf/post/webrtc-avatarify-face-swap-tutorial/ title="实现前端网页 WebRTC 视频通话以及换脸特效">https://blog.jiandan.cf/post/webrtc-avatarify-face-swap-tutorial/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/react-intro/ rel=next title="什么是 React？你为什么应该学React？"><i class="fa fa-chevron-left"></i> 什么是 React？你为什么应该学React？</a></div><div class="post-nav-prev post-nav-item"><a href=/post/deploy-a-docusaurus-site-part2/ rel=prev title="使用 Docusaurus 搭建个人博客教程（二）">使用 Docusaurus 搭建个人博客教程（二）
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=waline-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>爸比娃娃</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.116.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备 18047355-1 号</a>
<img src=/imgs/gongan.png alt=沪公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011402009770" target=_blank>沪公网安备 31011402009770 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel></a>
<a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云></a>
<a target=_blank href=https://webify.cloudbase.net title=Webify>Webify</a>
<span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://blog.jiandan.cf/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o \n\n可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄\n(Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.0fb3547374c917d23a2e5f762b70f3698d20b46a01cc18c38f9c467aeffc99fc.js defer></script></body></html>